<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Stevedores Dashboard{% endblock %}</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Stevedore Dashboard">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

    <!-- Theme colors -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-TileColor" content="#1e3a8a">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block head_extra %}{% endblock %}
</head>
<body>
    <header>
        <h1>Stevedores Dashboard</h1>
        <nav>
            <a href="{{ url_for('index') }}">Home</a>
            <a href="{{ url_for('ship_status') }}">Ship Status</a>
            <a href="{{ url_for('berth_management') }}">Berth Management</a>
            <a href="{{ url_for('vessel_schedules') }}">Vessel Schedules</a>
            <a href="{{ url_for('safety_protocols') }}">Safety Protocols</a>
            <a href="{{ url_for('emergency_contacts') }}">Emergency Contacts</a>
            <a href="{{ url_for('tide_tables') }}">Tide Tables</a>
        </nav>
    </header>

    <main>
        {% block content %}
        <p>Welcome to the Stevedores Dashboard!</p>
        {% endblock %}
    </main>

    <footer>
        <p>&copy; 2023 Maritime Operations</p>
    </footer>

    <!-- PWA Installation -->
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("{{ url_for('service_worker') }}")
                .then(reg => console.log('SW registered', reg))
                .catch(err => console.log('SW registration failed', err));
        }

        // PWA install prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = 'Install App';
        installButton.style.display = 'none'; // Initially hidden
        installButton.id = 'install-button'; // Added an ID for potential styling/selection

        function showInstallButton() {
            installButton.style.display = 'block';
            // You might want to append this button to a specific element in your UI
            // For now, let's append it to the body or a specific div if available.
            // Example: document.getElementById('pwa-install-container')?.appendChild(installButton);
            // If no specific container, it could be added to the body, but that's usually not ideal for layout.
            // Let's assume there's a placeholder div or it will be handled by page-specific JS.
            // For now, just logging it.
            console.log('Install button can be shown.');
            document.body.appendChild(installButton); // Example: append to body
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            showInstallButton();
        });

        installButton.addEventListener('click', async () => {
            // Hide our user interface that shows our A2HS button
            installButton.style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            // We've used the prompt, and can't use it again, discard it
            deferredPrompt = null;
        });

        window.addEventListener('appinstalled', (evt) => {
            // Log install to analytics or update UI
            console.log('App installed successfully');
            if (installButton) {
                installButton.style.display = 'none';
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts_extra %}{% endblock %}
</body>
</html>
